@page "/wallet"
@using Blazored.LocalStorage
@using LiveAuction.Client.Features.Wallets.Components
@using LiveAuction.Client.Services.TokenServices
@attribute [Authorize]

@implements IAsyncDisposable
@inject IWalletApi WalletApi
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ITokenService TokenService

<PageTitle>محفظتي</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h4" Class="mb-6">💰 محفظتي</MudText>

    @if (_isLoadingBalance)
    {
        <div class="d-flex justify-center align-center" style="height: 150px;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else
    {
        <MudGrid Class="mb-8">
            <MudItem xs="12" sm="4">
                <MudPaper Elevation="3" Class="pa-6 mud-theme-success d-flex flex-column justify-space-between" Style="height: 100%;">
                    <div>
                        <MudText Typo="Typo.subtitle1" Class="mb-1">الرصيد المتاح</MudText>
                        <MudText Typo="Typo.h4">@_summary.AvailableBalance.ToString("C0")</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircleOutline" Size="Size.Large" Class="align-self-end mt-2" />
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Elevation="3" Class="pa-6 mud-theme-warning d-flex flex-column justify-space-between" Style="height: 100%;">
                    <div>
                        <MudText Typo="Typo.subtitle1" Class="mb-1">مبالغ محجوزة (في مزادات)</MudText>
                        <MudText Typo="Typo.h4">@_summary.LockedBalance.ToString("C0")</MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.LockClock" Size="Size.Large" Class="align-self-end mt-2" />
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="4">
                <MudPaper Elevation="3" Class="pa-6 mud-theme-primary d-flex flex-column justify-space-between" Style="height: 100%;">
                    <div>
                        <MudText Typo="Typo.subtitle1" Class="mb-1">إجمالي رصيد الحساب</MudText>
                        <MudText Typo="Typo.h4">@_summary.TotalBalance.ToString("C0")</MudText>
                    </div>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.AddCard"
                               Class="mt-4 align-self-start"
                               OnClick="OpenDepositDialog">
                        شحن المحفظة
                    </MudButton>
                </MudPaper>
            </MudItem>
        </MudGrid>
    }

    <MudText Typo="Typo.h5" Class="mb-4 mt-8">سجل المعاملات</MudText>
    <div class="d-flex justify-center mb-6">
        <MudTextField @bind-Value="_searchTerm"
                      Placeholder="ابحث عن منتج..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.End"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      OnDebounceIntervalElapsed="OnSearch"
                      DebounceInterval="500"
                      Class="mt-0"
                      Style="max-width: 500px;" />
    </div>

    <MudTable ServerData="@LoadServerData"
              @ref="_table"
              Hover="true"
              Breakpoint="Breakpoint.Sm"
              Elevation="3"
              Dense="true"
              Striped="true">

        <HeaderContent>
            <MudTh>التاريخ</MudTh>
            <MudTh>نوع العملية</MudTh>
            <MudTh>المزاد</MudTh>
            <MudTh>المبلغ</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="التاريخ">
                @context.Timestamp.ToLocalTime().ToString("dd/MM/yyyy hh:mm tt")
            </MudTd>

            <MudTd DataLabel="نوع العملية">
                <MudChip T="string" Size="Size.Small" Color="@GetTransactionColor(context.Type)">
                    @context.Type
                </MudChip>
            </MudTd>

            <MudTd DataLabel="المزاد">
                @if (!string.IsNullOrEmpty(context.AuctionName))
                {
                    <MudLink Href="@($"/auctions/{context.AuctionId}/details")" Underline="Underline.Hover">
                        @context.AuctionName
                    </MudLink>
                }
                else
                {
                    <MudText Typo="Typo.caption" Color="Color.Default">-</MudText>
                }
            </MudTd>

            <MudTd DataLabel="المبلغ">
                <MudText Color="@GetAmountColor(context.Type)" Style="font-weight:bold">
                    @context.Amount.ToString("C0")
                </MudText>
            </MudTd>
        </RowTemplate>

        <NoRecordsContent>
            <MudAlert Severity="Severity.Info" Class="my-2">لا توجد معاملات سابقة.</MudAlert>
        </NoRecordsContent>

        <PagerContent>
            <MudTablePager RowsPerPageString="عدد الصفوف:"
                           PageSizeOptions="new int[] { 5, 10, 20, 50 }"
                           InfoFormat="{first_item}-{last_item} من {all_items}"
                           HorizontalAlignment="HorizontalAlignment.Center" />
        </PagerContent>

    </MudTable>

</MudContainer>

@code {
    private WalletSummaryResponse _summary = new();
    private bool _isLoadingBalance = true;

    private HubConnection? _hubConnection;

    private MudTable<TransactionResponse>? _table;
    private string _searchTerm = string.Empty;

    private async Task OnSearch()
    {
        if (_table != null)
        {
            await _table.ReloadServerData();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadBalanceOnly();
        await SetupSignalRConnection();
    }

    private async Task LoadBalanceOnly()
    {
        try
        {
            _isLoadingBalance = true;
            var response = await WalletApi.GetWalletSummaryAsync();

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<WalletSummaryResponse>();
                if (result != null)
                {
                    _summary = result;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading balance: {ex.Message}");
            Snackbar.Add("فشل تحميل الرصيد", Severity.Error);
        }
        finally
        {
            _isLoadingBalance = false;
        }
    }

    private async Task<TableData<TransactionResponse>> LoadServerData(TableState state, CancellationToken token)
    {
        try
        {
            var pageNumber = state.Page + 1;
            var pageSize = state.PageSize;

            var responseMessage = await WalletApi.GetTransactionsAsync(new PaginatedRequest
            {
                PageNumber = pageNumber,
                PageSize = pageSize,
                SearchTerm = _searchTerm?.Trim()
            });
            if (!responseMessage.IsSuccessStatusCode)
            {
                return new TableData<TransactionResponse> { TotalItems = 0, Items = [] };
            }
            var response = await responseMessage.Content.ReadFromJsonAsync<PaginatedResult<TransactionResponse>>();

            return new TableData<TransactionResponse>
            {
                TotalItems = response!.TotalCount,
                Items = response.Items
            };
        }
        catch
        {
            return new TableData<TransactionResponse> { TotalItems = 0, Items = [] };
        }
    }


    private async Task SetupSignalRConnection()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl($"{HostUrl.Current}/hubs/auction", options =>
            {
                options.AccessTokenProvider = async () => await TokenService.GetAccessTokenAsync();
            })
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On(MethodNames.ForceRefreshWallet, async () =>
        {
            Console.WriteLine("🔔 SignalR: Refreshing Wallet Data...");

            await LoadBalanceOnly();

            if (_table != null)
            {
                await _table.ReloadServerData();
            }

            await InvokeAsync(StateHasChanged);
        });

        await _hubConnection.StartAsync();
    }


    private async Task OpenDepositDialog()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<DepositDialog>("شحن المحفظة", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadBalanceOnly();
            if (_table != null) await _table.ReloadServerData();
        }
    }

    private Color GetTransactionColor(string type) => type switch
    {
        nameof(TransactionType.Deposit) => Color.Success,
        nameof(TransactionType.Release) => Color.Info,
        nameof(TransactionType.Hold) => Color.Warning,
        nameof(TransactionType.Purchase) => Color.Error,
        _ => Color.Default
    };

    private Color GetAmountColor(string type) =>
        (type == nameof(TransactionType.Deposit) || type == nameof(TransactionType.Release)) ? Color.Success : Color.Error;

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.StopAsync();
            await _hubConnection.DisposeAsync();
        }
    }
}