@page "/register"
@using LiveAuction.Client.Features.Users.Services
@using System.ComponentModel.DataAnnotations

@inject IAuthApi AuthApi
@inject NavigationManager NavManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar

<PageTitle>حساب جديد</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudCard Elevation="4" Class="pa-4">
        <MudText Typo="Typo.h5" Align="Align.Center" Class="mb-4">🚀 انضم للمزاد</MudText>

        <MudForm @ref="form" @bind-IsValid="@success">

            <MudTextField Label="الاسم الكامل"
                          @bind-Value="model.FullName"
                          For="@(() => model.FullName)"
                          Variant="Variant.Outlined"
                          Class="mb-3"
                          Immediate="true" /> <MudTextField Label="الإيميل"
                                                            @bind-Value="model.Email"
                                                            For="@(() => model.Email)"
                                                            Variant="Variant.Outlined"
                                                            Class="mb-3"
                                                            Immediate="true" />

            <MudTextField Label="الباسورد"
                          @bind-Value="model.Password"
                          For="@(() => model.Password)"
                          Variant="Variant.Outlined"
                          InputType="InputType.Password"
                          Class="mb-3"
                          Immediate="true" />

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       FullWidth="true"
                       Disabled="@(!success || _processing)"
                       OnClick="Submit">
                @(_processing ? "جاري التسجيل..." : "تسجيل حساب")
            </MudButton>
        </MudForm>

        <MudLink Href="/login" Class="d-flex justify-center mt-3">لديك حساب بالفعل؟</MudLink>
    </MudCard>
</MudContainer>

@code {
    MudForm form = default!;
    bool success;
    private RegisterRequest model = new();
    private bool _processing = false;

    private async Task Submit()
    {
        await form.Validate();

        if (form.IsValid)
        {
            _processing = true;
            try
            {
                var response = await AuthApi.RegisterAsync(model);

                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("تم التسجيل بنجاح! جاري الدخول...", Severity.Success);

                    var authResponse = await response.Content.ReadFromJsonAsync<AuthResponse>();

                    if (AuthStateProvider is CustomAuthStateProvider customAuthState)
                    {
                        await customAuthState.MarkUserAsAuthenticated(authResponse!.Token, authResponse.RefreshToken);
                    }

                    NavManager.NavigateTo("/");
                }
                else
                {
                    var errorMsg = await response.Content.ReadAsStringAsync();
                    if (string.IsNullOrWhiteSpace(errorMsg)) errorMsg = "حدث خطأ غير متوقع.";

                    Snackbar.Add(errorMsg, Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add("فشل الاتصال بالسيرفر.", Severity.Error);
                Console.WriteLine(ex.Message);
            }
            finally
            {
                _processing = false;
            }
        }
    }
}