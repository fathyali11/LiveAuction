@page "/login"
@using LiveAuction.Client.Features.Users.Services
@using System.ComponentModel.DataAnnotations

@inject IAuthApi AuthApi
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<PageTitle>تسجيل الدخول</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudCard Elevation="4" Class="pa-4 rounded-lg">

        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Primary"><b>👋 أهلاً بيك يا بطل</b></MudText>
                <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-1">سجل دخول عشان تتابع مزاداتك</MudText>
            </CardHeaderContent>
        </MudCardHeader>

        <MudCardContent>
            <MudForm @ref="form" @bind-IsValid="@success">

                <MudTextField Label="الإيميل"
                              @bind-Value="model.Email"
                              For="@(() => model.Email)"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email"
                              Class="mb-4"
                              Immediate="true" /> <MudTextField Label="الباسورد"
                                                                @bind-Value="model.Password"
                                                                For="@(() => model.Password)"
                                                                Variant="Variant.Outlined"
                                                                InputType="InputType.Password"
                                                                Adornment="Adornment.Start"
                                                                AdornmentIcon="@Icons.Material.Filled.Lock"
                                                                Class="mb-4"
                                                                Immediate="true" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           Size="Size.Large"
                           Disabled="@(!success || _processing)"
                           OnClick="Submit"
                           Class="mt-2">
                    @if (_processing)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">جاري الدخول...</MudText>
                    }
                    else
                    {
                        <MudText>دخول</MudText>
                    }
                </MudButton>

            </MudForm>
        </MudCardContent>

        <MudCardActions Class="d-flex justify-center pb-4">
            <MudLink Href="/register" Color="Color.Secondary" Typo="Typo.body2">ليس لديك حساب؟ انضم إلينا الآن</MudLink>
        </MudCardActions>

    </MudCard>
</MudContainer>

@code {
    MudForm form = default!;
    bool success;
    private LoginRequest model = new();
    private bool _processing = false;

    private async Task Submit()
    {
        await form.Validate();

        if (form.IsValid)
        {
            await DoLogin();
        }
    }

    private async Task DoLogin()
    {
        _processing = true;

        try
        {
            var response = await AuthApi.LoginAsync(model);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<AuthResponse>();

                if (AuthStateProvider is CustomAuthStateProvider customAuthState)
                {
                    await customAuthState.MarkUserAsAuthenticated(result!.Token, result.RefreshToken);
                }

                Snackbar.Add("نورت يا غالي! 🚀", Severity.Success);
                NavManager.NavigateTo("/");
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();

                if (string.IsNullOrWhiteSpace(errorMsg))
                {
                    errorMsg = "الإيميل أو الباسورد غير صحيح";
                }

                Snackbar.Add(errorMsg, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            Snackbar.Add("حدث خطأ في الاتصال بالسيرفر", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }
}