@page "/login"
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavManager
@inject ISnackbar Snackbar

<PageTitle>تسجيل الدخول</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudCard Elevation="4" Class="pa-4 rounded-lg">

        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h5" Align="Align.Center" Color="Color.Primary"><b>👋 أهلاً بيك يا بطل</b></MudText>
                <MudText Typo="Typo.body2" Align="Align.Center" Class="mt-1">سجل دخول عشان تتابع مزاداتك</MudText>
            </CardHeaderContent>
        </MudCardHeader>

        <MudCardContent>
            <EditForm Model="@model" OnValidSubmit="DoLogin">
                <DataAnnotationsValidator />

                <MudTextField Label="الإيميل"
                              @bind-Value="model.Email"
                              For="@(() => model.Email)"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Email"
                              Class="mb-4" />

                <MudTextField Label="الباسورد"
                              @bind-Value="model.Password"
                              For="@(() => model.Password)"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Lock"
                              Class="mb-4" />

                <MudButton ButtonType="ButtonType.Submit"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           Size="Size.Large"
                           Disabled="_processing"
                           Class="mt-2">
                    @if (_processing)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">جاري الدخول...</MudText>
                    }
                    else
                    {
                        <MudText>دخول</MudText>
                    }
                </MudButton>

            </EditForm>
        </MudCardContent>

        <MudCardActions Class="d-flex justify-center pb-4">
            <MudLink Href="/register" Color="Color.Secondary" Typo="Typo.body2">ليس لديك حساب؟ انضم إلينا الآن</MudLink>
        </MudCardActions>

    </MudCard>
</MudContainer>

@code {
    private LoginRequest model = new();
    private bool _processing = false;

    private async Task DoLogin()
    {
        _processing = true;

        try
        {
            var response = await Http.PostAsJsonAsync("api/auths/login", model);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<AuthResponse>();
                await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsAuthenticated(result!.Token,result.RefreshToken);
                Snackbar.Add("نورت يا غالي! 🚀", Severity.Success);
                NavManager.NavigateTo("/");
            }
            else
            {
                Snackbar.Add("الإيميل أو الباسورد غير صحيح", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("حدث خطأ في الاتصال بالسيرفر", Severity.Error);
        }

        _processing = false;
    }
}