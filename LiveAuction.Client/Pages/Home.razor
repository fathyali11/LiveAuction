@page "/"

@inject ISnackbar Snackbar
@inject IAuctionsApi AuctionsApi
@inject IWatchlistApi WatchlistApi
@inject NavigationManager NavManager
@inject AuthenticationStateProvider AuthStateProvider


<PageTitle>المزادات الحالية</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h4" Class="mb-6" Color="Color.Primary">🔥 المزادات المشتعلة الآن</MudText>

    @if (isLoading)
    {
        <div class="d-flex justify-center mt-16">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
        </div>
    }
    else if (auctions == null || auctions.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mt-4">
            لا توجد مزادات نشطة حالياً. كن أول من <MudLink Href="/create-auction" Color="Color.Inherit">يفتح مزاد!</MudLink>
        </MudAlert>
    }
    else
    {
        <MudGrid>
            @foreach (var auction in auctions)
            {
                <MudItem xs="12" sm="6" md="4">
                   <AuctionCard AuctionId="@auction.Id"
                                 Title="@auction.Title"
                                 ImageName="@auction.ImageName"
                                 EndTime="@auction.EndTime"
                                 CurrentBid="@auction.CurrentBid"
                                 IsFavorite="@auction.IsWatchListed"
                                 OnFavoriteToggled="UpdateFavoriteStatus" />
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>


    @code {
    [CascadingParameter]
    public MainLayout mainLayout { get; set; } = default!;

    private List<AuctionsInHomePageDto>? auctions;
    private bool isLoading = true;
    private bool _processingFavorite = false;
    

    protected override async Task OnInitializedAsync()
    {
        await LoadAuctions();
        await LoadWatchlistCount();
       
    }

    private async Task LoadWatchlistCount()
    {
        try
        {
            var count = await WatchlistApi.GetCountAsync();
            mainLayout.UpdateWatchlistCount(count);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading watchlist count: {ex.Message}");
        }
    }

    private async Task LoadAuctions()
    {
        try
        {
            isLoading = true;
            auctions = await AuctionsApi.GetAllAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            Snackbar.Add("حدث خطأ أثناء جلب المزادات. حاول مرة أخرى لاحقاً.", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void UpdateFavoriteStatus((int AuctionId, bool IsFavorite) args)
    {
        var auction = auctions?.FirstOrDefault(a => a.Id == args.AuctionId);
        if (auction != null)
        {
            Console.WriteLine($"Home: Updating IsWatchListed for AuctionId={args.AuctionId} to {args.IsFavorite}");
            auction.IsWatchListed = args.IsFavorite;
            StateHasChanged();
        }
    }


    
}