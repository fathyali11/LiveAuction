@page "/watchlist"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.SignalR.Client
@attribute [Authorize]

@inject ISnackbar Snackbar
@inject HttpClient Http
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>قائمتي للمراقبة</PageTitle>
<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h4" Class="mb-6" Color="Color.Primary">قائمتي للمراقبة</MudText>
    @if (isLoading)
    {
        <div class="d-flex justify-center mt-16">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
        </div>
    }
    else if (watchList?.Items == null || watchList?.Items.Count == 0)
    {
        <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mt-4">
            لا توجد عناصر في قائمتك للمراقبة حالياً. تصفح 
        <MudLink Href="/" Color="Color.Inherit">المزادات الحالية</MudLink> لإضافة عناصر إلى قائمتك للمراقبة.
        </MudAlert>
    }
    else
    {
        <MudGrid>
            @foreach (var auction in watchList?.Items!)
            {
                <MudItem xs="12" sm="6" md="4">
                    <MudCard Elevation="3" Class="rounded-lg hover-effect h-100" Style="position: relative;">

                        <div style="position: absolute; top: 8px; right: 8px; z-index: 10;">
                            <MudIconButton Icon="@(auction.IsInWatchList? Icons.Material.Filled.Favorite : Icons.Material.Outlined.FavoriteBorder)"
                                           Color="@(auction.IsInWatchList ? Color.Error : Color.Default)"
                                           Style="background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);"
                                           Size="Size.Medium"
                                           OnClick="@(() => ToggleFavorite(auction))"
                                           aria-label="إضافة إلى المفضلة" />
                        </div>

                        <MudCardMedia Image="@GetImageUrl(auction.ImageName)" Height="200" />

                        <MudCardContent>
                            <MudText Typo="Typo.h6" Lines="1">@auction.Title</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                ينتهي خلال: @(GetTimeRemaining(auction.EndTime))
                            </MudText>

                            <div class="d-flex justify-space-between mt-3 align-center">
                                <MudText Color="Color.Success" Typo="Typo.h5">
                                    <b>$@auction.CurrentPrice.ToString("N2")</b>
                                </MudText>
                                @if (string.Equals(GetTimeRemaining(auction.EndTime), "انتهى"))
                                {
                                    <MudChip T="string" Color="Color.Default" Size="Size.Small" Icon="@Icons.Material.Filled.HourglassDisabled">
                                        انتهى
                                    </MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Color="Color.Error" Size="Size.Small" Icon="@Icons.Material.Filled.LocalFireDepartment">
                                        Live
                                    </MudChip>
                                }
                            </div>
                        </MudCardContent>

                        <MudCardActions>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       FullWidth="true"
                                       OnClick="@(() => GoToDetails(auction.AuctionId))">
                                زايد الآن 🔨
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }

        </MudGrid>
    }


    
    

</MudContainer>

@code {

    [CascadingParameter]
    public MainLayout mainLayout { get; set; } = default!;

    private WatchListDto? watchList;
    private bool isLoading = true;
    private HubConnection hubConnection = default!;
    private const string LocalImagePath = "https://localhost:7293/images/";

    protected override async Task OnInitializedAsync()
    {
        var count = await Http.GetFromJsonAsync<int>("api/watchlists/count");
        mainLayout.UpdateWatchlistCount(count);
        await LoadWatchlistItems();

        try
        {
            hubConnection = new HubConnectionBuilder()
            .WithUrl("https://localhost:7293/hubs/auction")
            .WithAutomaticReconnect()
            .Build();

            hubConnection.On<BidDto>("NewBidPlaced", async bid =>
               {
                   await InvokeAsync(async () =>
                   {
                       var item = watchList?.Items?.FirstOrDefault(a => a.AuctionId == bid.AuctionId);
                       if (item != null)
                       {
                           item.CurrentPrice = bid.Amount;
                           StateHasChanged();
                       }
                   });
               });

            Console.WriteLine("Hub connection will be created.");
            await hubConnection.StartAsync();
            Console.WriteLine("Hub connection started.");

            if (hubConnection.State == HubConnectionState.Connected)
            {
                if (watchList?.Items != null)
                    foreach (var auction in watchList?.Items!)
                        await hubConnection.SendAsync("JoinToGroub", auction!.AuctionId.ToString());
            }

            hubConnection.Reconnected += async (string? connectionId) =>
            {
                Console.WriteLine("Reconnected to hub.");
                if (hubConnection.State == HubConnectionState.Connected)
                {
                    if (watchList?.Items != null)
                        foreach (var auction in watchList?.Items!)
                            await hubConnection.SendAsync("JoinToGroub", auction!.AuctionId.ToString());
                }
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error setting up SignalR hub connection: {ex.Message}");
        }
    }

    private async Task LoadWatchlistItems()
    {
        try
        {
            isLoading = true;
            watchList = await Http.GetFromJsonAsync<WatchListDto>("api/watchlists");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading watchlist items: {ex.Message}");
            Snackbar.Add("حدث خطأ أثناء تحميل عناصر قائمة المراقبة.", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }


    private string GetImageUrl(string imageName)
    {
        if (string.IsNullOrEmpty(imageName))
            return "https://via.placeholder.com/400x200?text=No+Image";
        return $"{LocalImagePath}{imageName}";
    }

    private string GetTimeRemaining(DateTime endTime)
    {
        var remaining = endTime - DateTime.UtcNow;
        if (remaining.TotalSeconds <= 0) return "انتهى";
        if (remaining.TotalDays >= 1) return $"{(int)remaining.TotalDays}ي {remaining.Hours}س";
        return $"{remaining.Hours}س {remaining.Minutes}د";
    }
    private void GoToDetails(int auctionId)
    {
        Navigation.NavigateTo($"/auctions/{auctionId}/details");
    }

    private async Task ToggleFavorite(ToggleWatchListItemResponse auction)
    {
        try
        {
            var request = new ToggleWatchListItemRequest
            {
                AuctionId = auction.AuctionId,
                Title = auction.Title,
                ImageName = auction.ImageName,
                CurrentPrice = auction.CurrentPrice,
                EndTime = auction.EndTime
            };
            var response = await Http.PostAsJsonAsync("api/watchlists/toggle", request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ToggleWatchListItemResponse>();
                if (result != null)
                {
                    auction.IsInWatchList = result.IsInWatchList;
                    var message = result.IsInWatchList
                        ? $"✅ تمت إضافة '{auction.Title}' إلى قائمة المتابعة"
                        : $"❌ تمت إزالة '{auction.Title}' من قائمة المتابعة";
                    Snackbar.Add(message, result.IsInWatchList ? Severity.Success : Severity.Info);
                    watchList!.Items!.RemoveAll(a => a.AuctionId == auction.AuctionId);
                    StateHasChanged();
                    var count = await Http.GetFromJsonAsync<int>("api/watchlists/count");
                    mainLayout.UpdateWatchlistCount(count);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error in toggling response favorite: {error}");
                Snackbar.Add("حدث خطأ أثناء تحديث قائمة المتابعة", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error Exception toggling favorite: {ex.Message}");
            Snackbar.Add("حدث خطأ أثناء تحديث قائمة المتابعة", Severity.Error);
        }
    }


    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            if (watchList?.Items != null)
                foreach (var auction in watchList?.Items!)
                    await hubConnection.SendAsync("LeaveFromGroub", auction!.AuctionId.ToString());
            await hubConnection.StopAsync();
            await hubConnection.DisposeAsync();
        }
    }
}
