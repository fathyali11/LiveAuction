@page "/watchlist"

@attribute [Authorize]

@inject ISnackbar Snackbar
@inject IWatchlistApi WatchlistApi
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ILocalStorageService LocalStorage
@inject IDialogService DialogService
@implements IAsyncDisposable

<PageTitle>قائمتي للمراقبة</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mt-md-8 mb-8">

    <div class="animate__animated animate__fadeInRight">
        <MudText Typo="Typo.h5" Class="mb-4 d-flex d-sm-none" Color="Color.Primary">قائمتي للمراقبة</MudText>
        <MudText Typo="Typo.h4" Class="mb-6 d-none d-sm-flex" Color="Color.Primary">قائمتي للمراقبة</MudText>
    </div>

    @if (_isLoading)
    {
        <div class="d-flex justify-center mt-16">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" Class="zoom-in-animation" />
        </div>
    }
    else if (_watchlistItems == null || !_watchlistItems.Any())
    {
        <div class="animate__animated animate__pulse">
            <MudAlert Severity="Severity.Info" Variant="Variant.Filled" Class="mt-4">
                لا توجد عناصر في قائمتك للمراقبة حالياً. تصفح
                <MudLink Href="/" Color="Color.Inherit">المزادات الحالية</MudLink> لإضافة عناصر.
            </MudAlert>
        </div>
    }
    else
    {
        <div class="d-flex align-center mb-6 gap-3 animate__animated animate__fadeInDown">

            <MudTextField @bind-Value="_searchTerm"
                          Placeholder="ابحث عن منتج..."
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          OnDebounceIntervalElapsed="OnSearch"
                          DebounceInterval="500"
                          Class="flex-grow-1"
                          Style="background-color: rgba(255,255,255,0.05); border-radius: 8px;"
                          Margin="Margin.Dense" />

            <div class="animate__animated hover-shake">

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.DeleteSweep"
                           OnClick="OnClearAllClicked"
                           Class="d-none d-sm-flex py-2 px-4"
                           Style="height: 40px; white-space: nowrap;">
                    حذف الكل
                </MudButton>

                <MudIconButton Icon="@Icons.Material.Filled.DeleteSweep"
                               Variant="Variant.Outlined"
                               Color="Color.Error"
                               OnClick="OnClearAllClicked"
                               Class="d-flex d-sm-none"
                               Style="border-radius: 8px; height: 40px; width: 40px;" />
            </div>

        </div>
        <MudGrid Spacing="2">
            @{
                int i = 0;
            }
            @foreach (var auction in _watchlistItems)
            {
                var delay = i * 0.1;
                i++;

                <MudItem xs="12" sm="6" md="4" lg="3"
                         Class="animate__animated animate__fadeInUp"
                         Style="@($"animation-delay: {delay}s; animation-duration: 0.5s;")">

                    <div class="mud-hover-card" style="height: 100%; border-radius: 8px;">
                        <AuctionCard AuctionId="@auction.AuctionId"
                                     Title="@auction.Title"
                                     ImageName="@auction.ImageName"
                                     EndTime="@auction.EndTime"
                                     CurrentBid="@auction.CurrentBid"
                                     IsFavorite="@auction.IsInWatchList"
                                     OnFavoriteToggled="UpdateFavoriteStatus" />
                    </div>
                </MudItem>
            }
        </MudGrid>

        <div class="d-flex flex-column align-center mt-8 animate__animated animate__zoomIn" style="animation-delay: 0.3s;">
            <MudPagination Color="Color.Primary"
                           Count="@_totalPages"
                           Selected="@_pageNumber"
                           SelectedChanged="OnPageChanged"
                           Variant="Variant.Outlined"
                           Shape="Shape.Rounded"
                           Size="Size.Medium"
                           BoundaryCount="1"
                           MiddleCount="3" />

            <MudText Typo="Typo.caption" Class="mt-2 text-muted">
                صفحة @_pageNumber من @_totalPages
            </MudText>
        </div>
    }

</MudContainer>

<style>
    .mud-hover-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        .mud-hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }

    .hover-shake:hover {
        animation: headShake 0.5s;
    }

    .zoom-in-animation {
        animation: zoomIn 0.4s ease-out;
    }
</style>

@code {
    [CascadingParameter]
    private MainLayout Layout { get; set; } = default!;
    private List<WatchListItemDto> _watchlistItems = new();

    private bool _isLoading = true;

    private int _pageNumber = 1;
    private int _pageSize = 8;
    private int _totalPages = 1;
    private int _totalCount = 0;
    private string _searchTerm = string.Empty;


    private HubConnection? _hubConnection;

    protected override async Task OnInitializedAsync()
    {
        await SetupSignalRConnection();
        await LoadWatchlistData();
    }

    private async Task OnSearch()
    {
        _pageNumber = 1;
        await LoadWatchlistData();
    }

    private async Task OnPageChanged(int i)
    {
        _pageNumber = i;
        await LoadWatchlistData();
        await JSRuntime.InvokeVoidAsync("window.scrollTo", 0, 0);
    }

    private async Task LoadWatchlistData()
    {
        try
        {
            var cacheKey = $"watchlist_data_{_pageNumber}_{_searchTerm}";
            await ManageSignalRGroups(_watchlistItems, false);
            var cacheData = await LocalStorage.GetItemAsync<PaginatedResult<WatchListItemDto>>(cacheKey);

            if (cacheData is not null && cacheData.Items.Any())
            {
                _watchlistItems = cacheData.Items;
                _pageNumber = cacheData.PageNumber;
                _totalCount = cacheData.TotalCount;
                _totalPages = (int)Math.Ceiling((double)cacheData.TotalCount / _pageSize);
                if (_totalPages == 0) _totalPages = 1;

                _isLoading = false;
                StateHasChanged();
                await ManageSignalRGroups(_watchlistItems, true);
            }

            _isLoading = true;

            await ManageSignalRGroups(_watchlistItems, false);
            var paginatedRequest = new PaginatedRequest
            {
                PageNumber = _pageNumber,
                PageSize = _pageSize,
                SearchTerm = _searchTerm
            };
            var responseMessage = await WatchlistApi.GetWatchlistAsync(paginatedRequest);
            if (!responseMessage.IsSuccessStatusCode)
            {
                Snackbar.Add("حدث خطأ أثناء تحميل القائمة.", Severity.Error);
                return;
            }
            var paginatedResult = await responseMessage.Content.ReadFromJsonAsync<PaginatedResult<WatchListItemDto>>();

            if (paginatedResult is null)
            {
                Snackbar.Add("حدث خطأ أثناء تحميل القائمة.", Severity.Error);
                return;
            }
            if (cacheData is not null && cacheData.Items.Any())
            {
                await ManageSignalRGroups(_watchlistItems, false);
            }
            _watchlistItems = paginatedResult.Items;
            _pageNumber = paginatedResult.PageNumber;
            _totalCount = paginatedResult.TotalCount;
            _totalPages = (int)Math.Ceiling((double)paginatedResult.TotalCount / _pageSize);
            if (_totalPages == 0) _totalPages = 1;

            await LocalStorage.SetItemAsync(cacheKey, paginatedResult);
            await ManageSignalRGroups(_watchlistItems, true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading watchlist: {ex.Message}");
            Snackbar.Add("حدث خطأ أثناء تحميل القائمة.", Severity.Error);
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ManageSignalRGroups(List<WatchListItemDto> items, bool join)
    {
        if (_hubConnection?.State == HubConnectionState.Connected && items != null && items.Any())
        {
            var methodName = join ? MethodNames.JoinToGroup : MethodNames.LeaveFromGroup;
            foreach (var item in items)
            {
                await _hubConnection.SendAsync(methodName, item.AuctionId.ToString());
            }
        }
    }

    private async Task SetupSignalRConnection()
    {
        try
        {
            _hubConnection = new HubConnectionBuilder()
                .WithUrl($"{HostUrl.Current}/hubs/auction")
                .WithAutomaticReconnect()
                .Build();

            _hubConnection.On<BidDto>(MethodNames.NewBidPlaced, async bid =>
            {
                await InvokeAsync(() =>
                {
                    var item = _watchlistItems.FirstOrDefault(a => a.AuctionId == bid.AuctionId);
                    if (item != null)
                    {
                        item.CurrentBid = bid.Amount;
                        StateHasChanged();
                    }
                });
            });

            await _hubConnection.StartAsync();
            _hubConnection.Reconnected += async (connectionId) =>
           {
               await ManageSignalRGroups(_watchlistItems, true);
           };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR Error: {ex.Message}");
        }
    }

    private async Task UpdateFavoriteStatus((int AuctionId, bool IsFavorite) args)
    {
        var item = _watchlistItems.FirstOrDefault(a => a.AuctionId == args.AuctionId);
        if (item != null)
        {
            item.IsInWatchList = args.IsFavorite;
            if (!args.IsFavorite)
            {
                _watchlistItems.Remove(item);
                _totalCount--;

                if (_hubConnection?.State == HubConnectionState.Connected)
                {
                    await _hubConnection.SendAsync(MethodNames.LeaveFromGroup, args.AuctionId.ToString());
                }
                string cacheKey = $"watchlist_data_{_pageNumber}_{_searchTerm}";
                _ = UpdateCacheAfterRemoval(cacheKey);

                if (!_watchlistItems.Any())
                {
                    if (!string.IsNullOrWhiteSpace(_searchTerm))
                    {
                        _searchTerm = string.Empty;
                        _pageNumber = 1;
                        await LoadWatchlistData();
                    }
                    else if (_pageNumber > 1)
                    {
                        _pageNumber--;
                        await LoadWatchlistData();
                    }
                    else
                    {
                        await LoadWatchlistData();
                    }
                }
            }
            StateHasChanged();
        }
    }

    private async Task UpdateCacheAfterRemoval(string key)
    {
        var currentData = await LocalStorage.GetItemAsync<PaginatedResult<WatchListItemDto>>(key);

        if (currentData != null)
        {
            currentData.Items = _watchlistItems;
            currentData.TotalCount = _totalCount;
            await LocalStorage.SetItemAsync(key, currentData);
        }
    }

    private async Task OnClearAllClicked()
    {
        bool? result = await DialogService.ShowMessageBox(
            "تأكيد الحذف",
            "هل أنت متأكد أنك تريد حذف جميع العناصر من قائمتك للمراقبة؟",
            yesText: "نعم",
            noText: "لا");
        if (result == true)
        {
            try
            {
                var response = await WatchlistApi.ClearAsync();
                if (response.IsSuccessStatusCode)
                {
                    await ManageSignalRGroups(_watchlistItems, false);
                    _watchlistItems.Clear();
                    _totalCount = 0;
                    _pageNumber = 1;
                    _totalPages = 1;
                    Snackbar.Add("تم حذف جميع العناصر من قائمتك للمراقبة.", Severity.Success);
                    Layout.UpdateWatchlistCount(0);
                    StateHasChanged();
                }
                else
                {
                    Snackbar.Add("حدث خطأ أثناء حذف القائمة.", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error clearing watchlist: {ex.Message}");
                Snackbar.Add("حدث خطأ أثناء حذف القائمة.", Severity.Error);
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection != null)
        {
            await ManageSignalRGroups(_watchlistItems, false);
            await _hubConnection.StopAsync();
            await _hubConnection.DisposeAsync();
        }
    }
}