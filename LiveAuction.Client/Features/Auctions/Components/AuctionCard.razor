@inject NavigationManager NavManager
@implements IAsyncDisposable

<MudCard Elevation="3" Class="rounded-lg hover-effect h-100" Style="position: relative;">

    <AddFavouriteComponent AuctionId="@AuctionId"
                           IsFavorite="@IsFavorite"
                           OnFavoriteToggled="UpdateFavoriteStatus" />

    <MudCardMedia Image="@GetImageUrl(ImageName)" Height="200" />

    <MudCardContent>
        <MudText Typo="Typo.h6" Lines="1">@Title</MudText>
        <MudText Typo="Typo.caption" Color="Color.Secondary">
            ينتهي خلال: @(GetTimeRemaining(EndTime))
        </MudText>

        <div class="d-flex justify-space-between mt-3 align-center">
            <MudText Color="Color.Success" Typo="Typo.h5">
                <b>$@CurrentBid.ToString("N2")</b>
            </MudText>
            @if (string.Equals(GetTimeRemaining(EndTime), "انتهى"))
            {
                <MudChip T="string" Color="Color.Default" Size="Size.Small" Icon="@Icons.Material.Filled.HourglassDisabled">
                    انتهى
                </MudChip>
            }
            else
            {
                <MudChip T="string" Color="Color.Error" Size="Size.Small" Icon="@Icons.Material.Filled.LocalFireDepartment">
                    Live
                </MudChip>
            }
        </div>
    </MudCardContent>

    <MudCardActions>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   FullWidth="true"
                   OnClick="@(() => GoToDetails(AuctionId))">
            زايد الآن 🔨
        </MudButton>
    </MudCardActions>
</MudCard>
@code {
    [Parameter] public int AuctionId { get; set; }
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public string ImageName { get; set; } = string.Empty;
    [Parameter] public DateTime EndTime { get; set; }
    [Parameter] public decimal CurrentBid { get; set; }
    [Parameter] public bool IsFavorite { get; set; }
    [Parameter] public EventCallback<(int AuctionId, bool IsFavorite)> OnFavoriteToggled { get; set; }
    private Timer _timer;

    private const string LocalImagePath = "https://localhost:7293/images/";
    protected override async Task OnInitializedAsync()
    {
        _timer = new Timer(1000);
        _timer.Elapsed += async (s, e) =>
        {
            await InvokeAsync(StateHasChanged);
        };
        _timer.Start();
    }
    private void GoToDetails(int id)
    {
        NavManager.NavigateTo($"/auctions/{id}/details");
    }

    private string GetTimeRemaining(DateTime endTime)
    {
        var remaining = endTime - DateTime.UtcNow;
        if (remaining.TotalSeconds <= 0) return "انتهى";
        if (remaining.TotalDays >= 1) return $"{(int)remaining.TotalDays}ي {remaining.Hours}س";
        return $"{remaining.Hours}س {remaining.Minutes}د {remaining.Seconds}ث";
    }

    private string GetImageUrl(string imageName)
    {
        if (string.IsNullOrEmpty(imageName))
            return "https://via.placeholder.com/400x200?text=No+Image";
        return $"{LocalImagePath}{imageName}";
    }
    private async Task UpdateFavoriteStatus((int AuctionId, bool IsFavorite) args)
    {
        if (OnFavoriteToggled.HasDelegate)
        {
            Console.WriteLine($"AuctionCard: Invoking OnFavoriteToggled for AuctionId={args.AuctionId}, IsFavorite={args.IsFavorite}");
            await OnFavoriteToggled.InvokeAsync((args.AuctionId,args.IsFavorite));
        }
    }
    public async ValueTask DisposeAsync()
    {
        if (_timer != null)
        {
            _timer.Stop();
            _timer.Dispose();
        }
    }
}
