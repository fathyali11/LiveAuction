@inject INotificationsApi NotificationsApi
@inject ITokenService TokenService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<MudMenu AnchorOrigin="Origin.BottomCenter"
         TransformOrigin="Origin.TopCenter"
         MaxHeight="400"
         Class="mr-2"
         PopoverClass="notification-menu-popover">

    <ActivatorContent>
        <MudBadge Content="_unreadCount"
                  Color="Color.Error"
                  Overlap="true"
                  Visible="@(_unreadCount > 0)"
                  Class="badge-positioning">
            <MudIconButton Icon="@Icons.Material.Filled.Notifications" Color="Color.Inherit" />
        </MudBadge>
    </ActivatorContent>

    <ChildContent>
        <div class="pa-3 d-flex justify-space-between align-center border-b-2" style="background-color: var(--mud-palette-background-grey);">
            <div class="d-flex align-center gap-2">
                <MudIcon Icon="@Icons.Material.Filled.NotificationsActive" Size="Size.Small" Color="Color.Primary" />
                <MudText Typo="Typo.subtitle2" Style="font-weight:bold">الإشعارات</MudText>
            </div>
            @if (_unreadCount > 0)
            {
                <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" OnClick="MarkAllRead">تحديد الكل</MudButton>
            }
        </div>

        @if (_isLoadingNotifications)
        {
            <div class="d-flex justify-center pa-4">
                <MudProgressCircular Indeterminate="true" Size="Size.Small" Color="Color.Primary" />
            </div>
        }
        else if (_notifications == null || !_notifications.Any())
        {
            <div class="d-flex flex-column align-center justify-center pa-6">
                <MudIcon Icon="@Icons.Material.Outlined.NotificationsOff" Size="Size.Large" Style="opacity: 0.5; margin-bottom: 8px;" />
                <MudText Typo="Typo.body2" Color="Color.Secondary" Style="opacity: 0.7;">لا يوجد جديد</MudText>
            </div>
        }
        else
        {
            int i = 0;
            @foreach (var note in _notifications)
            {
                var delay = i * 0.05; i++;

                <MudMenuItem OnClick="@(() => OnNotificationClick(note))"
                             Class="mb-1 animate__animated animate__fadeIn"
                             Style="@($"animation-delay: {delay}s; " + (note.IsRead ? "opacity: 0.8;" : "background-color: rgba(var(--mud-palette-primary-rgb), 0.08); border-right: 3px solid var(--mud-palette-primary);"))">

                    <div class="d-flex gap-3 align-start" style="min-width: 280px;">
                        <MudAvatar Size="Size.Medium" Color="@GetIconColor(note.NotificationType)" Variant="Variant.Filled" Class="mt-1">
                            <MudIcon Icon="@GetIcon(note.NotificationType)" Size="Size.Small" />
                        </MudAvatar>

                        <div class="d-flex flex-column" style="width: 100%; white-space: normal;">
                            <div class="d-flex justify-space-between align-center">
                                <MudText Typo="Typo.subtitle2" Color="@(note.IsRead? Color.Default: Color.Primary)" Style="font-weight: 700; font-size: 0.9rem;">
                                    @note.Title
                                </MudText>
                                @if (!note.IsRead)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Primary" Style="font-size: 8px;" />
                                }
                            </div>

                            <MudText Typo="Typo.body2" Class="my-1 text-muted" Style="line-height: 1.4; font-size: 0.85rem;">@note.Message</MudText>

                            <MudText Typo="Typo.caption" Color="Color.Default" Style="opacity: 0.6; font-size: 10px;">
                                @GetTimeAgo(note.CreatedAt)
                            </MudText>
                        </div>
                    </div>
                </MudMenuItem>
                <MudDivider />
            }
        }
    </ChildContent>
</MudMenu>

<style>
    .badge-positioning .mud-badge {
        top: 8px !important;  
        right: 6px !important; 
        border: 2px solid var(--mud-palette-appbar-background); 
    }

        .badge-positioning .mud-badge:not(:empty) {
            animation: pulse-badge 2s infinite;
        }

    .notification-menu-popover {
        width: 360px;
        max-width: 100vw;
    }

    @@media (max-width: 600px) {
        .notification-menu-popover {
            position: fixed !important;
            top: 65px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 95% !important;
            max-width: 95% !important;
            margin: 0 auto !important;
        }
    }

    @@keyframes pulse-badge {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.1);
        }

        100% {
            transform: scale(1);
        }
    }
</style>

@code {
    [CascadingParameter] private Task<AuthenticationState> AuthStateTask { get; set; } = default!;

    private List<NotificationDto> _notifications = new();
    private int _unreadCount = 0;
    private bool _isLoadingNotifications = true;
    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateTask;
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            await LoadNotificationsData();
            await SetupSignalRConnection();
        }
    }

    private async Task LoadNotificationsData()
    {
        try
        {
            _isLoadingNotifications = true;
            var response = await NotificationsApi.GetNotificationsAsync();
            if (response.IsSuccessStatusCode)
            {
                _notifications = await response.Content.ReadFromJsonAsync<List<NotificationDto>>() ?? new();
            }

            var countResponse = await NotificationsApi.GetUnreadCountAsync();
            if (countResponse.IsSuccessStatusCode)
            {
                _unreadCount = await countResponse.Content.ReadFromJsonAsync<int>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            _isLoadingNotifications = false;
            StateHasChanged();
        }
    }

    private async Task SetupSignalRConnection()
    {
        try
        {
            hubConnection = new HubConnectionBuilder()
            .WithUrl($"{HostUrl.Current}/hubs/auction", options =>
            {
                options.AccessTokenProvider = async () => await TokenService.GetAccessTokenAsync();
            })
            .WithAutomaticReconnect()
            .Build();

            hubConnection.On<NotificationDto>(MethodNames.NewNotification, (notification) =>
            {
                InvokeAsync(() =>
                {
                    _notifications.Insert(0, notification);
                    _unreadCount++;
                    StateHasChanged();
                    if (!notification.Title.Contains("Deposit Successful") && !notification.Title.Contains("تم الإيداع"))
                    {
                        var severity = GetSeverity(notification);

                        Snackbar.Add(notification.Title, severity, config =>
                        {
                            config.Icon = GetIcon(notification.NotificationType);
                            config.HideTransitionDuration = 200;
                
                            if (severity == Severity.Success) config.VisibleStateDuration = 5000;
                        });
                    }
                    
                });
            });

            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SignalR Error: {ex.Message}");
        }
    }

    private async Task OnNotificationClick(NotificationDto note)
    {
        if (!note.IsRead)
        {
            note.IsRead = true;
            _unreadCount = Math.Max(0, _unreadCount - 1);
            await NotificationsApi.MarkAsReadAsync(note.Id);
        }

        if (note.RelatedEntityId.HasValue)
            NavigationManager.NavigateTo($"/auctions/{note.RelatedEntityId}/details");
        else
            NavigationManager.NavigateTo("/wallet");
    }

    private async Task MarkAllRead()
    {
        foreach (var n in _notifications) n.IsRead = true;
        _unreadCount = 0;
        await NotificationsApi.MarkAllAsReadAsync();
    }

    private string GetIcon(string? type) => type switch
    {
        nameof(NotificationType.Wallet) => Icons.Material.Filled.AttachMoney,
        nameof(NotificationType.Auction) => Icons.Material.Filled.Gavel,
        _ => Icons.Material.Filled.Notifications
    };

    private Color GetIconColor(string? type) => type switch
    {
        nameof(NotificationType.Wallet) => Color.Success,
        nameof(NotificationType.Auction) => Color.Warning,
        _ => Color.Info
    };

    private string GetTimeAgo(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        if (span.TotalMinutes < 1) return "الآن";
        if (span.TotalMinutes < 60) return $"منذ {span.TotalMinutes:0} د";
        if (span.TotalHours < 24) return $"منذ {span.TotalHours:0} س";
        return $"منذ {span.TotalDays:0} ي";
    }
    private Severity GetSeverity(NotificationDto note)
    {
        if (note.NotificationType == nameof(NotificationType.Wallet) ||
            note.Title.Contains("مبروك") ||
            note.Title.Contains("نجاح") ||
            note.Title.Contains("Success") ||
            note.Title.Contains("Won"))
        {
            return Severity.Success;
        }

        if (note.Title.Contains("انتهى") || note.Title.Contains("Ended"))
        {
            return Severity.Info;  
        }

        return Severity.Info;
    }
}